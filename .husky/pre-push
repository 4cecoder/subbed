#!/usr/bin/env sh

echo "üî• SUPER STRICT PRE-PUSH: FINAL QUALITY GATE..."
echo "==============================================="

# Set strict error handling
set -e

# Function to handle failures
handle_failure() {
    echo "‚ùå PUSH REJECTED: $1"
    echo "Fix all issues before pushing. No exceptions."
    exit 1
}

echo "üîç Step 1/5: Running full test suite (Jest)..."
if [ "$SKIP_TESTS" = "1" ] || [ "$ALLOW_FAILING_TESTS" = "1" ]; then
  echo "‚ö†Ô∏è  Tests skipped due to environment override (SKIP_TESTS/ALLOW_FAILING_TESTS=1)"
else
  bunx jest --coverage || handle_failure "Tests failed"
fi

echo "üîç Step 2/5: Running production build test..."
bun run build || handle_failure "Production build failed"

echo "üîç Step 3/5: Running final linting check..."
bunx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0 || handle_failure "ESLint issues found"

echo "üîç Step 4/5: Validating TypeScript with strict mode..."
bunx tsc --noEmit --strict || handle_failure "TypeScript strict mode failed"

echo "üîç Step 5/5: Final security scan..."
if git log --oneline -10 | grep -iE '(password|secret|key|token|api_key)'; then
    echo "‚ö†Ô∏è  WARNING: Recent commits mention sensitive keywords. Please review."
    echo "Continue? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
        handle_failure "Push cancelled by user due to security concerns"
    fi
fi

echo "‚úÖ ALL PRE-PUSH CHECKS PASSED! Safe to deploy."
echo "==============================================="