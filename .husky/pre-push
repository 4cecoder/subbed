#!/usr/bin/env sh

echo "ğŸ”¥ SUPER STRICT PRE-PUSH: FINAL QUALITY GATE..."
echo "==============================================="

# Set strict error handling
set -e

# Function to handle failures
handle_failure() {
    echo "âŒ PUSH REJECTED: $1"
    echo "Fix all issues before pushing. No exceptions."
    exit 1
}

echo "ğŸ” Step 1/5: Running full test suite..."
bun test --coverage || handle_failure "Tests failed"

echo "ğŸ” Step 2/5: Running production build test..."
bun run build || handle_failure "Production build failed"

echo "ğŸ” Step 3/5: Running final linting check..."
bunx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0 || handle_failure "ESLint issues found"

echo "ğŸ” Step 4/5: Validating TypeScript with strict mode..."
bunx tsc --noEmit --strict || handle_failure "TypeScript strict mode failed"

echo "ğŸ” Step 5/5: Final security scan..."
if git log --oneline -10 | grep -iE '(password|secret|key|token|api_key)'; then
    echo "âš ï¸  WARNING: Recent commits mention sensitive keywords. Please review."
    echo "Continue? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
        handle_failure "Push cancelled by user due to security concerns"
    fi
fi

echo "âœ… ALL PRE-PUSH CHECKS PASSED! Safe to deploy."
echo "==============================================="